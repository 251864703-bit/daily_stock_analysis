name: æ¯æ—¥è‚¡ç¥¨åˆ†æ

on:
  schedule:
    - cron: '0 10 * * 1-5'
  workflow_dispatch:
    inputs:
      mode:
        description: 'æ¨¡å¼'
        required: true
        default: 'stocks-only'
        type: choice
        options: [full, market-only, stocks-only]

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: å®‰è£…æ ¸å¿ƒä¾èµ–
        run: |
          pip install --upgrade pip
          pip install openai pandas yfinance requests akshare efinance
          [ -f requirements.txt ] && (grep -v "pandas_ta" requirements.txt > req_new.txt && pip install -r req_new.txt || echo "skip")

      - name: åˆ›å»ºç›®å½•
        run: mkdir -p data logs reports
      
      - name: æ‰§è¡Œåˆ†æ (ç»“æœç›´æ¥è¾“å‡º)
        env:
          OPENAI_API_KEY: ${{ secrets.DEEP_SEEK_KEY }}
          OPENAI_BASE_URL: "https://api.deepseek.com"
          OPENAI_MODEL: "deepseek-chat"
          REALTIME_SOURCE_PRIORITY: "tencent,akshare_sina,efinance"
          STOCK_LIST: ${{ vars.STOCK_LIST || secrets.STOCK_LIST || '600519' }}
          PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
        run: |
          # è¿è¡Œç¨‹åº
          python main.py --model "deepseek-chat" --no-market-review
          
          echo ""
          echo "=========================================="
          echo "ğŸ“ æ·±åº¦åˆ†ææŠ¥å‘Šé¢„è§ˆ (ç›´æ¥åœ¨æ­¤æŸ¥çœ‹)"
          echo "=========================================="
          # å¯»æ‰¾ç”Ÿæˆçš„ä»»ä½•æŠ¥å‘Šæ–‡ä»¶å¹¶ç›´æ¥æ‰“å°å‡ºæ¥
          find reports -name "*.md" -exec cat {} + || echo "âš ï¸ æœªæ‰¾åˆ° Markdown æŠ¥å‘Šï¼Œè¯·æ£€æŸ¥ logs ç›®å½•"
          echo "=========================================="

      - name: å¼ºåˆ¶ä¸Šä¼ æ‰€æœ‰ç”Ÿæˆçš„å†…å®¹
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: all-outputs-${{ github.run_number }}
          path: |
            reports/**/*
            logs/*.log
