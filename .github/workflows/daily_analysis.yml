name: æ¯æ—¥è‚¡ç¥¨åˆ†æè¿›é˜¶ç‰ˆ

on:
  schedule:
  # ä¸´æ—¶æµ‹è¯•ç‚¹ï¼šåŒ—äº¬æ—¶é—´ 13:20
    - cron: '20 5 * * 1-5'
    # 1. åŒ—äº¬æ—¶é—´ 09:35 (UTC 01:35) - å¼€ç›˜å¼‚åŠ¨æ•æ‰
    - cron: '35 1 * * 1-5'
    # 2. åŒ—äº¬æ—¶é—´ 14:45 (UTC 06:45) - å°¾ç›˜åšå¼ˆå†³ç­–
    - cron: '45 6 * * 1-5'
    # 3. åŒ—äº¬æ—¶é—´ 18:00 (UTC 10:00) - æ”¶ç›˜æ€»ç»“
    - cron: '0 10 * * 1-5'
  
  workflow_dispatch:
    inputs:
      mode:
        description: 'è¿è¡Œæ¨¡å¼'
        required: true
        default: 'stocks-only'
        type: choice
        options: [full, market-only, stocks-only]

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          pip install --upgrade pip
          pip install openai pandas yfinance requests akshare efinance
          [ -f requirements.txt ] && (grep -v "pandas_ta" requirements.txt > req_new.txt && pip install -r req_new.txt || echo "skip")

      - name: æ‰§è¡Œåˆ†æ (ç»“æ„åŒ–ç›‘æ§æ¨¡å¼)
        env:
          # æ ¸å¿ƒ API é…ç½®
          OPENAI_API_KEY: ${{ secrets.DEEP_SEEK_KEY }}
          OPENAI_BASE_URL: "https://api.deepseek.com"
          OPENAI_MODEL: "deepseek-chat"
          MODEL_NAME: "deepseek-chat"
          
          # ä¼ä¸šå¾®ä¿¡é€šçŸ¥é€šé“ (å·²æ¥é€š)
          WECHAT_WEBHOOK_URL: ${{ secrets.WECHAT_WEBHOOK_URL }}
          
          # è‚¡ç¥¨æ¸…å•ä¸è¡Œæƒ…é…ç½®
          STOCK_LIST: ${{ vars.STOCK_LIST || secrets.STOCK_LIST || '600519' }}
          REALTIME_SOURCE_PRIORITY: "tencent,akshare_sina,efinance"
          TUSHARE_TOKEN: "" 
        run: |
          # è·å–åŒ—äº¬æ—¶é—´å°æ—¶
          HOUR=$(TZ='Asia/Shanghai' date +%H)
          echo "=========================================="
          echo "â° å½“å‰åŒ—äº¬æ—¶é—´: $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M')"
          
          if [ "$HOUR" -eq 9 ] || [ "$HOUR" -eq 10 ]; then
            echo "ğŸš€ æ¨¡å¼ï¼šã€æ—©ç›˜å¼‚åŠ¨ç›‘æ§ã€‘"
            echo "é‡ç‚¹ï¼šè¯†åˆ«å¼€ç›˜é‡èƒ½ï¼Œæ ‡æ³¨å…³é”®æ”¯æ’‘/å‹åŠ›ä½"
            python main.py --no-market-review
          elif [ "$HOUR" -eq 14 ]; then
            echo "ğŸ”” æ¨¡å¼ï¼šã€å°¾ç›˜å†³ç­–æé†’ã€‘"
            echo "é‡ç‚¹ï¼šç»™å‡ºæ˜ç¡®ä¹°å–å»ºè®®ï¼Œé˜²æ­¢ç ´ä½æˆ–ç¡®è®¤çªç ´"
            python main.py --no-market-review
          else
            echo "ğŸ“Š æ¨¡å¼ï¼šã€å…¨å¤©æ€»ç»“å¤ç›˜ã€‘"
            echo "é‡ç‚¹ï¼šæŠ€æœ¯é¢è¶‹åŠ¿æ·±åº¦åˆ†æï¼Œæ›´æ–°æ˜æ—¥è§‚å¯Ÿä½"
            python main.py --no-market-review
          fi
          echo "=========================================="

      - name: ç»“æœå±•ç¤º
        if: always()
        run: |
          echo "ğŸ“ æ£€æŸ¥åˆ†ææŠ¥å‘Šå†…å®¹..."
          find reports -name "*.md" -exec cat {} + || echo "æœªå‘ç°æŠ¥å‘Š"
      
      - name: ä¸Šä¼ äº§å‡ºæ–‡ä»¶
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: stock-results-${{ github.run_number }}
          path: |
            reports/
            logs/
